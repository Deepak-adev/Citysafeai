<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafeRoute - Crime Prevention System</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        #map { height: 100vh; width: 100%; }
        .sidebar {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
            width: 250px;
        }
        .route-btn {
            background: #ffa500;
            color: black;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
        }
        .location-input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: none;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="sidebar">
        <h3>SafeRoute - Public</h3>
        <button class="route-btn" onclick="getCurrentLocation()" id="locationBtn">Get Current Location</button>
        <input type="text" class="location-input" id="to" placeholder="To location" value="Coimbatore">
        <button class="route-btn" onclick="findRoute()">Find Safe Route</button>
        <button class="route-btn" onclick="toggleView()" id="viewBtn">Show Crime Zones</button>
        <div id="status" style="margin-top: 10px; font-size: 12px;">Ready</div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script>
        let map;
        let routeControl;
        let crimeLayer;
        let heatLayer;
        let crimeData = [];
        let showZones = false;
        let currentLocation = null;

        function initMap() {
            map = L.map('map').setView([12.5, 78.5], 7);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        }
        
        function getCurrentLocation() {
            const btn = document.getElementById('locationBtn');
            const status = document.getElementById('status');
            
            btn.innerHTML = 'Getting location...';
            status.innerHTML = 'Getting your location...';
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        currentLocation = [position.coords.latitude, position.coords.longitude];
                        map.setView(currentLocation, 12);
                        
                        // Add marker for current location
                        L.marker(currentLocation).addTo(map)
                            .bindPopup('Your Current Location')
                            .openPopup();
                        
                        btn.innerHTML = 'Current Location Set';
                        btn.style.background = '#32cd32';
                        status.innerHTML = 'Current location found';
                    },
                    function(error) {
                        btn.innerHTML = 'Location Failed';
                        status.innerHTML = 'Could not get location';
                    }
                );
            } else {
                btn.innerHTML = 'Not Supported';
                status.innerHTML = 'Geolocation not supported';
            }
        }

        async function geocode(city) {
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${city}`);
            const data = await response.json();
            return data.length > 0 ? [parseFloat(data[0].lat), parseFloat(data[0].lon)] : null;
        }

        async function loadCrimeData() {
            const response = await fetch('/api/crime-predictions/?city=TamilNadu&count=50');
            const data = await response.json();
            return data.status === 'success' ? data.coordinates : [];
        }

        function clearLayers() {
            if (routeControl) map.removeControl(routeControl);
            if (crimeLayer) map.removeLayer(crimeLayer);
            if (heatLayer) map.removeLayer(heatLayer);
        }

        function showCrimeZones() {
            if (crimeLayer) map.removeLayer(crimeLayer);
            
            crimeLayer = L.layerGroup();
            crimeData.forEach(coord => {
                const color = coord.risk_level === 'high' ? '#ff0000' : 
                             coord.risk_level === 'medium' ? '#ff8c00' : '#32cd32';
                
                L.circle([coord.lat, coord.lng], {
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.4,
                    radius: 10000,
                    weight: 2
                }).addTo(crimeLayer);
            });
            
            crimeLayer.addTo(map);
        }

        function showHeatMap() {
            if (heatLayer) map.removeLayer(heatLayer);
            
            const heatPoints = crimeData.map(coord => {
                const intensity = coord.risk_level === 'high' ? 1.0 : 
                                 coord.risk_level === 'medium' ? 0.6 : 0.3;
                return [coord.lat, coord.lng, intensity];
            });
            
            heatLayer = L.heatLayer(heatPoints, {
                radius: 25,
                blur: 15,
                gradient: {0.2: 'blue', 0.4: 'lime', 0.6: 'yellow', 0.8: 'orange', 1.0: 'red'}
            }).addTo(map);
        }

        function avoidCrimeZones(start, end) {
            const waypoints = [L.latLng(start[0], start[1])];
            
            // Get ALL crime zones
            const allZones = crimeData;
            
            // Create safe path by adding multiple waypoints that avoid ALL zones
            const safeWaypoints = createSafePath(start, end, allZones);
            waypoints.push(...safeWaypoints);
            
            waypoints.push(L.latLng(end[0], end[1]));
            return waypoints;
        }
        
        function getPathPoints(start, end, numPoints) {
            const points = [];
            for (let i = 0; i <= numPoints; i++) {
                const ratio = i / numPoints;
                const lat = start[0] + (end[0] - start[0]) * ratio;
                const lng = start[1] + (end[1] - start[1]) * ratio;
                points.push([lat, lng]);
            }
            return points;
        }
        
        function getDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Earth radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        function createSafePath(start, end, allZones) {
            const safePoints = [];
            
            // Create grid of potential waypoints
            const steps = 5;
            const latStep = (end[0] - start[0]) / steps;
            const lngStep = (end[1] - start[1]) / steps;
            
            for (let i = 1; i < steps; i++) {
                let baseLat = start[0] + (latStep * i);
                let baseLng = start[1] + (lngStep * i);
                
                // Try different offsets to find safe point
                let safePoint = findSafePoint(baseLat, baseLng, allZones);
                if (safePoint) {
                    safePoints.push(L.latLng(safePoint[0], safePoint[1]));
                }
            }
            
            return safePoints;
        }
        
        function findSafePoint(lat, lng, zones) {
            // Try original point first
            if (isPointSafe(lat, lng, zones)) {
                return [lat, lng];
            }
            
            // Try offsets in all directions
            const offsets = [
                [0.2, 0], [-0.2, 0], [0, 0.2], [0, -0.2],
                [0.2, 0.2], [-0.2, -0.2], [0.2, -0.2], [-0.2, 0.2],
                [0.4, 0], [-0.4, 0], [0, 0.4], [0, -0.4]
            ];
            
            for (let offset of offsets) {
                const testLat = lat + offset[0];
                const testLng = lng + offset[1];
                if (isPointSafe(testLat, testLng, zones)) {
                    return [testLat, testLng];
                }
            }
            
            return null;
        }
        
        function isPointSafe(lat, lng, zones) {
            for (let zone of zones) {
                const distance = getDistance(lat, lng, zone.lat, zone.lng);
                if (distance <= 12) { // 12km buffer to ensure no intersection
                    return false;
                }
            }
            return true;
        }

        async function findRoute() {
            const status = document.getElementById('status');
            
            if (!currentLocation) {
                status.innerHTML = 'Please get current location first';
                return;
            }
            
            status.innerHTML = 'Finding route...';
            
            const to = document.getElementById('to').value;
            const toCoords = await geocode(to);
            
            if (!toCoords) {
                status.innerHTML = 'Destination not found';
                return;
            }
            
            crimeData = await loadCrimeData();
            clearLayers();
            
            const waypoints = avoidCrimeZones(currentLocation, toCoords);
            
            routeControl = L.Routing.control({
                waypoints: waypoints,
                createMarker: () => null,
                lineOptions: {
                    styles: [{ color: '#00ff00', weight: 4, opacity: 0.8 }]
                }
            }).addTo(map);
            
            if (showZones) {
                showCrimeZones();
            }
            
            status.innerHTML = `Safe route: Current Location → ${to}`;
        }

        function toggleView() {
            const btn = document.getElementById('viewBtn');
            showZones = !showZones;
            
            if (showZones) {
                showCrimeZones();
                btn.innerHTML = 'Hide Crime Zones';
            } else {
                if (crimeLayer) map.removeLayer(crimeLayer);
                btn.innerHTML = 'Show Crime Zones';
            }
        }

        window.onload = initMap;
    </script>
</body>
</html>